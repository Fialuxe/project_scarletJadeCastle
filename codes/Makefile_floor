# Makefile for Modular Aincrad Floor Project

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -Wno-deprecated-declarations -Isrc
TARGET = aincrad_floor

# GLFW Configuration
GLFW_DIR = libs/glfw
GLFW_BUILD_DIR = $(GLFW_DIR)/build
GLFW_LIB = $(GLFW_BUILD_DIR)/src/libglfw3.a
GLFW_INCLUDE = -I$(GLFW_DIR)/include

# Source files
SRCS = src/main.c \
       src/core/window.c src/core/input.c src/core/camera.c \
       src/graphics/shader.c src/graphics/texture.c src/graphics/mesh.c \
       src/graphics/water_fbo.c \
       src/utils/math_utils.c src/utils/file_utils.c

# Detect OS
UNAME_S := $(shell uname -s)

# Add assimp include and lib paths for macOS
ifneq ($(wildcard /opt/homebrew/include),)
    # Homebrew on Apple Silicon
    CFLAGS += -I/opt/homebrew/include -I/opt/homebrew/Cellar/assimp/6.0.2/include
    LIBS_PATH = -L/opt/homebrew/lib -L/opt/homebrew/Cellar/assimp/6.0.2/lib
else
    # Default or Linux
    LIBS_PATH =
endif

# Common Libs
COMMON_LIBS = -lm

# Assimp Configuration (Local Static Build)
ASSIMP_DIR = libs/assimp
ASSIMP_BUILD_DIR = $(ASSIMP_DIR)/build
ASSIMP_LIB = $(ASSIMP_BUILD_DIR)/lib/libassimp.a
ASSIMP_INCLUDE = -I$(ASSIMP_DIR)/include -I$(ASSIMP_BUILD_DIR)/include

ifneq ($(wildcard $(ASSIMP_LIB)),)
    # Use local static assimp if available
    CFLAGS += $(ASSIMP_INCLUDE)
    LIBS_PATH += -L$(ASSIMP_BUILD_DIR)/lib
    ASSIMP_LINK = -lassimp
else
    # Fallback to system assimp (or homebrew)
    ifneq ($(wildcard /opt/homebrew/include),)
        CFLAGS += -I/opt/homebrew/include -I/opt/homebrew/Cellar/assimp/6.0.2/include
        LIBS_PATH += -L/opt/homebrew/lib -L/opt/homebrew/Cellar/assimp/6.0.2/lib
    endif
    ASSIMP_LINK = -lassimp
endif

ifeq ($(UNAME_S), Darwin)
	# Mac OS
	CFLAGS += $(GLFW_INCLUDE)
	LIBS = $(LIBS_PATH) $(GLFW_LIB) -framework OpenGL -framework Cocoa -framework IOKit -framework CoreVideo -framework QuartzCore $(ASSIMP_LINK) $(COMMON_LIBS) -lz
else
	# Linux / Other
	CFLAGS += $(GLFW_INCLUDE)
	# Link static GLFW and its dependencies (X11, etc.)
	LIBS = -L$(GLFW_BUILD_DIR) -lglfw3 -lGL -lX11 -lm -ldl -lpthread $(ASSIMP_LINK) -lz
endif

all: $(GLFW_LIB) $(TARGET)

# Build GLFW
$(GLFW_LIB):
ifeq ($(UNAME_S), Darwin)
	@echo "Building GLFW (macOS)..."
	mkdir -p $(GLFW_BUILD_DIR)
	cd $(GLFW_BUILD_DIR) && cmake .. -DGLFW_BUILD_EXAMPLES=OFF -DGLFW_BUILD_TESTS=OFF -DGLFW_BUILD_DOCS=OFF && make
else
	@echo "Building GLFW (Linux)..."
	cd $(GLFW_DIR)/src && make -f Makefile.linux
endif

$(TARGET): $(SRCS) $(GLFW_LIB)
	$(CC) $(CFLAGS) $(SRCS) -o $(TARGET) $(LIBS)

clean:
	rm -f $(TARGET)

clean_glfw:
	rm -rf $(GLFW_BUILD_DIR)

clean_all: clean clean_glfw
